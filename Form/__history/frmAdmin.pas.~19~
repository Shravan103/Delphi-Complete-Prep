unit frmAdmin;

interface

uses
  Winapi.Windows, Winapi.Messages, System.SysUtils, System.Variants, System.Classes, Vcl.Graphics,
  Vcl.Controls, Vcl.Forms, Vcl.Dialogs, Vcl.ExtCtrls, Vcl.StdCtrls, System.UITypes,
  Vcl.ComCtrls, Vcl.Grids, Vcl.DBGrids, Vcl.CheckLst, Vcl.Imaging.jpeg, DMMain, Data.DB,
  Vcl.Buttons;

type
  TAdminForm = class(TForm)
    PanelAdmin: TPanel;
    PanelHeaderAdmin: TPanel;
    LabelAssess360A: TLabel;
    PanelAdminSidebar: TPanel;
    BtnAdminCreateProj: TButton;
    BtnAdminProjAssign: TButton;
    BtnUserManage: TButton;
    BtnAdminAboutMe: TButton;
    PanelCreateNewProject: TPanel;
    PanelHeaderAdminCreateNewProj: TPanel;
    PanelProjectAssignment: TPanel;
    PanelHeaderAdminProjAssignment: TPanel;
    PanelUserManagement: TPanel;
    PanelUserManagementHeader: TPanel;
    PanelAdminAboutMe: TPanel;
    PanelHeaderAdminAboutMe: TPanel;
    EditNameAdminAM: TEdit;
    EditEmailAdminAM: TEdit;
    EditRoleAdminAM: TEdit;
    EditSubroleAdminAM: TEdit;
    LblNameAdminAM: TLabel;
    LblEmailAdminAM: TLabel;
    LblRoleAdminAM: TLabel;
    LblSubroleAdminAM: TLabel;
    PanelContDBGridCP: TPanel;
    DBGridCP: TDBGrid;
    PanelContEditBoxBtnCP: TPanel;
    EditProjectTitleCP: TEdit;
    BtnCreateNewProjectCP: TButton;
    MemoProjDescCP: TMemo;
    LblAdminProjectTitleCP: TLabel;
    LblAdminProjectDescCP: TLabel;
    LblAdminProjDeadlineCP: TLabel;
    DateTimePickerDeadlineCP: TDateTimePicker;
    PanelContDBGridUM: TPanel;
    DBGridUM: TDBGrid;
    PanelContEditBoxesUM: TPanel;
    EditUseridUM: TEdit;
    EditEmailUM: TEdit;
    EditNameUM: TEdit;
    ComboBoxRoleUM: TComboBox;
    EditPasswordUM: TEdit;
    ComboBoxSubroleUM: TComboBox;
    DateTimePickerJoiningDateUM: TDateTimePicker;
    LblAdminUMUserID: TLabel;
    LblAdminUMEmail: TLabel;
    LblAdminUMRole: TLabel;
    LblAdminUMSubrole: TLabel;
    LblAdminUMName: TLabel;
    LblAdminUMPassword: TLabel;
    LblAdminUMJoiningDate: TLabel;
    PanelContBtnUM: TPanel;
    BtnRemoveUser: TButton;
    BtnAddUser: TButton;
    BtnUpdateUser: TButton;
    PanelContDBGridPA: TPanel;
    DBGridPA: TDBGrid;
    PanelContEditboxesPA: TPanel;
    ComboBoxProjManagerPA: TComboBox;
    CheckListBoxEmployeesPA: TCheckListBox;
    LblProjectIdPA: TLabel;
    LblProjectManagerPA: TLabel;
    LblProjectEmployeePA: TLabel;
    BtnSubmitPA: TButton;
    ComboBoxProjectPA: TComboBox;
    LblAdminDashbaord: TLabel;
    ImgAdminAboutMe: TImage;
    BitBtnRefreshCP: TBitBtn;
    BitBtn1: TBitBtn;
    procedure BtnAdminCreateProjClick(Sender: TObject);
    procedure BtnAdminProjAssignClick(Sender: TObject);
    procedure BtnUserManageClick(Sender: TObject);
    procedure BtnAdminAboutMeClick(Sender: TObject);
    procedure BtnAddUserClick(Sender: TObject);
    procedure DBGridUMCellClick(Column: TColumn);
    procedure BtnRemoveUserClick(Sender: TObject);
    procedure BtnUpdateUserClick(Sender: TObject);
    procedure BtnCreateNewProjectCPClick(Sender: TObject);
    procedure DBGridCPCellClick(Column: TColumn);
//    procedure FormCreate(Sender: TObject);
    procedure BtnSubmitPAClick(Sender: TObject);
    procedure BitBtnRefreshCPClick(Sender: TObject);
    procedure BitBtn1Click(Sender: TObject);
    procedure FormShow(Sender: TObject);
  private
    { Private declarations }
  public
    { Public declarations }
    procedure LoadProjectAssignmentControls;
  end;

var
  AdminForm: TAdminForm;

implementation

{$R *.dfm}
//------------------------------------------------------------------------------

// REFRESH EDIT BOXES OF USER MANAGEMENT:
procedure TAdminForm.BitBtn1Click(Sender: TObject);
begin
  EditNameUM.Clear;
  EditUseridUM.Clear;
  EditEmailUM.Clear;
  ComboBoxRoleUM.Items.Clear;
  EditPasswordUM.Clear;
  ComboBoxSubroleUM.Clear;
  DateTimePickerJoiningDateUM.Date := NOW;
end;

//------------------------------------------------------------------------------

// REFRESH EDIT BOXES OF CREATE NEW PROJECT:
procedure TAdminForm.BitBtnRefreshCPClick(Sender: TObject);
begin
  EditProjectTitleCP.Clear;
  MemoProjDescCP.Clear;
  DateTimePickerDeadlineCP.Date := Now;
end;

//------------------------------------------------------------------------------

// INSERT USER:
procedure TAdminForm.BtnAddUserClick(Sender: TObject);
var
  roleText, subroleSQL: string;
begin
  case ComboBoxRoleUM.ItemIndex of
    0: roleText := 'Admin';
    1: roleText := 'Manager';
    2: roleText := 'Employee';
  else
    roleText := 'Employee';
  end;

  if roleText = 'Employee' then
    subroleSQL := IntToStr(ComboBoxSubroleUM.ItemIndex + 1)
  else
    subroleSQL := 'NULL'; // Admin and Manager.

  with DMMain.DataModule1.qryAdminInsDelUpdUsers do
  begin
    Close;
    SQL.Clear;
    SQL.Text :=
      'INSERT INTO users (name, email, password_hash, role, created_at, subrole_id) VALUES (' +
      QuotedStr(EditNameUM.Text) + ', ' +
      QuotedStr(EditEmailUM.Text) + ', ' +
      QuotedStr(EditPasswordUM.Text) + ', ' +
      QuotedStr(roleText) + ', ' +
      QuotedStr(FormatDateTime('yyyy-mm-dd', DateTimePickerJoiningDateUM.Date)) + ', ' +
      subroleSQL + ')';

    ExecSQL;
    MessageDlg('User added successfully!', mtConfirmation, [mbOK], 0);
  end;

  DMMain.DataModule1.qryDBGridUM.Close;
  DMMain.DataModule1.qryDBGridUM.Open;

  LoadProjectAssignmentControls;
end;

//------------------------------------------------------------------------------

// Z-INDEX SHIFTIING OF PANELS:
procedure TAdminForm.BtnAdminAboutMeClick(Sender: TObject);
begin
  PanelCreateNewProject.SendToBack;
  PanelProjectAssignment.SendToBack;
  PanelUserManagement.SendToBack;
  PanelAdminAboutMe.BringToFront;
end;

procedure TAdminForm.BtnAdminCreateProjClick(Sender: TObject);
begin
  PanelCreateNewProject.BringToFront;
  PanelProjectAssignment.SendToBack;
  PanelUserManagement.SendToBack;
  PanelAdminAboutMe.SendToBack;
end;

procedure TAdminForm.BtnAdminProjAssignClick(Sender: TObject);
begin
  PanelCreateNewProject.SendToBack;
  PanelProjectAssignment.BringToFront;
  PanelUserManagement.SendToBack;
  PanelAdminAboutMe.SendToBack;
end;

procedure TAdminForm.BtnUserManageClick(Sender: TObject);
begin
  PanelCreateNewProject.SendToBack;
  PanelProjectAssignment.SendToBack;
  PanelUserManagement.BringToFront;
  PanelAdminAboutMe.SendToBack;
end;

//------------------------------------------------------------------------------

// CREATE NEW PROJECT:
procedure TAdminForm.BtnCreateNewProjectCPClick(Sender: TObject);
begin
  if EditProjectTitleCP.Text = '' then
  begin
    MessageDlg('Please Enter Project Title.', mtWarning, [mbOK], 0);
    Exit;
  end;

  if MemoProjDescCP.Lines.Text = '' then
  begin
    MessageDlg('Please Enter Project Description.', mtWarning, [mbOK], 0);
    Exit;
  end;

  with DMMain.DataModule1.qryCreateProject do
  begin
    Close;
    SQL.Clear;
    SQL.Text :=
      'INSERT INTO projects (title, description, deadline) VALUES (' +
      QuotedStr(EditProjectTitleCP.Text) + ', ' +
      QuotedStr(MemoProjDescCP.Lines.Text) + ', ' +
      QuotedStr(FormatDateTime('yyyy-mm-dd', DateTimePickerDeadlineCP.Date)) + ')';
    ExecSQL;
  end;

  MessageDlg('Project created successfully!', mtInformation, [mbOK], 0);

  // Refresh grid data
  DMMain.DataModule1.qryDBGridCP.Close;
  DMMain.DataModule1.qryDBGridCP.Open;

  LoadProjectAssignmentControls
end;

//------------------------------------------------------------------------------

// UPDATE USER:
procedure TAdminForm.BtnUpdateUserClick(Sender: TObject);
var
  roleText, subroleSQL, userID: string;
begin
  userID := EditUseridUM.Text;

  if userID = '' then
  begin
    MessageDlg('Please select a user to update.', mtWarning, [mbOK], 0);
    Exit;
  end;

  // Determine role
  case ComboBoxRoleUM.ItemIndex of
    0: roleText := 'Admin';
    1: roleText := 'Manager';
    2: roleText := 'Employee';
  else
    roleText := 'Employee';
  end;

  // Determine subrole_id value
  if roleText = 'Employee' then
    subroleSQL := IntToStr(ComboBoxSubroleUM.ItemIndex + 1)
  else
    subroleSQL := 'NULL';

  with DMMain.DataModule1.qryAdminInsDelUpdUsers do
  begin
    Close;
    SQL.Clear;
    SQL.Text :=
      'UPDATE users SET ' +
      'name = ' + QuotedStr(EditNameUM.Text) + ', ' +
      'email = ' + QuotedStr(EditEmailUM.Text) + ', ' +
      'password_hash = ' + QuotedStr(EditPasswordUM.Text) + ', ' +
      'role = ' + QuotedStr(roleText) + ', ' +
      'created_at = ' + QuotedStr(FormatDateTime('yyyy-mm-dd', DateTimePickerJoiningDateUM.Date)) + ', ' +
      'subrole_id = ' + subroleSQL + ' ' +
      'WHERE user_id = ' + userID;

    ExecSQL;
    MessageDlg('User updated successfully.', mtInformation, [mbOK], 0);

    // Refresh the grid
    DMMain.DataModule1.qryDBGridUM.Close;
    DMMain.DataModule1.qryDBGridUM.Open;
  end;

  LoadProjectAssignmentControls;
end;

//------------------------------------------------------------------------------

// DELETE USER:
procedure TAdminForm.BtnRemoveUserClick(Sender: TObject);
var
  userID: string;
begin
  userID := Trim(EditUseridUM.Text);

  if userID = '' then
  begin
    MessageDlg('Please select a user to delete.', mtWarning, [mbOK], 0);
    Exit;
  end;

  if MessageDlg('Are you sure you want to delete this user?', mtConfirmation, [mbYes, mbNo], 0) = mrYes then
  begin
    with DMMain.DataModule1.qryAdminInsDelUpdUsers do
    begin
//      // Step 1: Delete from assessment_metrics (via assessments)
//      Close;
//      SQL.Clear;
//      SQL.Text :=
//        'DELETE am FROM assessment_metrics am ' +
//        'JOIN assessments a ON am.assessment_id = a.assessment_id ' +
//        'WHERE a.manager_id = ' + userID + ' OR a.employee_id = ' + userID;
//      ExecSQL;
//
//      // Step 2: Delete from assessments
//      Close;
//      SQL.Clear;
//      SQL.Text :=
//        'DELETE FROM assessments WHERE manager_id = ' + userID + ' OR employee_id = ' + userID;
//      ExecSQL;

      // Step 3: Delete from project_assignments
      Close;
      SQL.Clear;
      SQL.Text :=
        'DELETE FROM project_assignments WHERE manager_id = ' + userID + ' OR employee_id = ' + userID;
      ExecSQL;

      // Step 4: Delete from users
      Close;
      SQL.Clear;
      SQL.Text := 'DELETE FROM users WHERE user_id = ' + userID;
      ExecSQL;
    end;

    MessageDlg('User and related records deleted successfully.', mtInformation, [mbOK], 0);

    // Refresh grid
    DMMain.DataModule1.qryDBGridUM.Close;
    DMMain.DataModule1.qryDBGridUM.Open;

    DMMain.DataModule1.qryDBGridPA.Close;
    DMMain.DataModule1.qryDBGridPA.Open;

    DMMain.DataModule1.qryDBGridUM.Close;
    DMMain.DataModule1.qryDBGridUM.Open;
  end;

  LoadProjectAssignmentControls;
end;

//------------------------------------------------------------------------------

// PROJECT ASSIGNMENT:
procedure TAdminForm.BtnSubmitPAClick(Sender: TObject);
var
  i: Integer;
  ProjectID, SelectedManagerID, SelectedEmployeeID, ExistingManagerID: Integer;
begin
  // --- Validate selections ---
  if ComboBoxProjectPA.ItemIndex = -1 then
  begin
    MessageDlg('Please select a Project.', mtWarning, [mbOK], 0);
    Exit;
  end;

  if ComboBoxProjManagerPA.ItemIndex = -1 then
  begin
    MessageDlg('Please select a Project Manager.', mtWarning, [mbOK], 0);
    Exit;
  end;

  ProjectID := Integer(ComboBoxProjectPA.Items.Objects[ComboBoxProjectPA.ItemIndex]);
  SelectedManagerID := Integer(ComboBoxProjManagerPA.Items.Objects[ComboBoxProjManagerPA.ItemIndex]);

  // --- Check if project already has a manager ---
  with DMMain.DataModule1.qryAssignProject do
  begin
    Close;
    SQL.Text :=
      'SELECT DISTINCT manager_id FROM project_assignments WHERE project_id = ' + IntToStr(ProjectID);
    Open;

    if not IsEmpty then
    begin
      ExistingManagerID := FieldByName('manager_id').AsInteger;

      if ExistingManagerID <> SelectedManagerID then
      begin
        MessageDlg('This project is already assigned to a different manager. Please choose another project.', mtError, [mbOK], 0);
        Exit;
      end;

      // --- Same manager: clear existing employee assignments ---
      Close;
      SQL.Text :=
        'DELETE FROM project_assignments WHERE project_id = ' + IntToStr(ProjectID) +
        ' AND manager_id = ' + IntToStr(SelectedManagerID);
      ExecSQL;
    end;
  end;

  // --- Insert new employee assignments ---
  for i := 0 to CheckListBoxEmployeesPA.Items.Count - 1 do
  begin
    if CheckListBoxEmployeesPA.Checked[i] then
    begin
      SelectedEmployeeID := Integer(CheckListBoxEmployeesPA.Items.Objects[i]);

      with DMMain.DataModule1.qryAssignProject do
      begin
        Close;
        SQL.Text :=
          'INSERT INTO project_assignments (project_id, manager_id, employee_id) VALUES (' +
          QuotedStr(IntToStr(ProjectID)) + ', ' +
          QuotedStr(IntToStr(SelectedManagerID)) + ', ' +
          QuotedStr(IntToStr(SelectedEmployeeID)) + ')';
        ExecSQL;
      end;
    end;
  end;

  MessageDlg('Project successfully assigned to selected employees.', mtInformation, [mbOK], 0);

  DMMain.DataModule1.qryDBGridPA.Close;
  DMMain.DataModule1.qryDBGridPA.Open;
end;


//------------------------------------------------------------------------------

// FETCH DATA FROM GRID TO EDIT BOXES (CREATE PROJECT):
procedure TAdminForm.DBGridCPCellClick(Column: TColumn);
begin
  with DMMain.DataModule1.qryDBGridCP do
  begin
    if not IsEmpty then
    begin
      EditProjectTitleCP.Text := FieldByName('title').AsString;
      MemoProjDescCP.Lines.Text := FieldByName('description').AsString;

      if not FieldByName('deadline').IsNull then
        DateTimePickerDeadlineCP.Date := FieldByName('deadline').AsDateTime
      else
        DateTimePickerDeadlineCP.Date := Now;
    end;
  end;
end;

//------------------------------------------------------------------------------

// FETCH DATA FROM GRID TO EDIT BOXES (USER MANAGEMENT):
procedure TAdminForm.DBGridUMCellClick(Column: TColumn);
begin
  with DMMain.DataModule1.dsDBGridUM.DataSet do
  begin
    EditUseridUM.Text := FieldByName('user_id').AsString;
    EditNameUM.Text := FieldByName('name').AsString;
    EditEmailUM.Text := FieldByName('email').AsString;
    EditPasswordUM.Text := FieldByName('password_hash').AsString;
    ComboBoxRoleUM.Text := FieldByName('role').AsString;

    if not FieldByName('subrole_id').IsNull then
      ComboBoxSubroleUM.ItemIndex := FieldByName('subrole_id').AsInteger - 1
    else
      ComboBoxSubroleUM.ItemIndex := -1;

    DateTimePickerJoiningDateUM.Date := FieldByName('created_at').AsDateTime;
  end;
end;

//------------------------------------------------------------------------------

procedure TAdminForm.LoadProjectAssignmentControls;
var
  ProjectID: Integer;
begin
  // --- Load Projects into ComboBox ---
  with DMMain.DataModule1.qryProjectsManagersEmployees do
  begin
    Close;
    SQL.Text := 'SELECT project_id, title FROM projects ORDER BY title';
    Open;
    ComboBoxProjectPA.Items.Clear;
    while not Eof do
    begin
      ProjectID := FieldByName('project_id').AsInteger;
      ComboBoxProjectPA.Items.AddObject(FieldByName('title').AsString, TObject(ProjectID));
      Next;
    end;
  end;

  // --- Load Managers into ComboBox ---
  with DMMain.DataModule1.qryProjectsManagersEmployees do
  begin
    Close;
    SQL.Text := 'SELECT user_id, name FROM users WHERE role = "Manager" ORDER BY name';
    Open;
    ComboBoxProjManagerPA.Items.Clear;
    while not Eof do
    begin
      ComboBoxProjManagerPA.Items.AddObject(FieldByName('name').AsString,
                                            TObject(FieldByName('user_id').AsInteger));
      Next;
    end;
  end;

  // --- Load Employees into CheckListBox ---
  with DMMain.DataModule1.qryProjectsManagersEmployees do
  begin
    Close;
    SQL.Text := 'SELECT user_id, name FROM users WHERE role = "Employee" ORDER BY name';
    Open;
    CheckListBoxEmployeesPA.Items.Clear;
    while not Eof do
    begin
      CheckListBoxEmployeesPA.Items.AddObject(FieldByName('name').AsString,
                                              TObject(FieldByName('user_id').AsInteger));
      Next;
    end;
  end;
end;



// LOAD DATA INTO COMBOBOX AND CHECKLISTBOX IN PROJECT ASSIGNMENT:
//procedure TAdminForm.FormCreate(Sender: TObject);
//begin
//  LoadProjectAssignmentControls;
//end;


procedure TAdminForm.FormShow(Sender: TObject);
begin
  LoadProjectAssignmentControls;
end;

end.
